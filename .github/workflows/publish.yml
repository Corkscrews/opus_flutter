name: Publish to pub.dev

on:
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Dry run (validate only, do not publish)'
        type: boolean
        default: true

permissions:
  id-token: write

jobs:
  test:
    name: Analyze & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: stable
      - name: Check formatting
        run: ./scripts/format.sh
      - name: Run static analysis
        run: ./scripts/analyze.sh
      - name: Run unit tests
        run: ./scripts/unit_tests.sh

  publish-tier-1:
    name: 'Publish: ${{ matrix.package }}'
    runs-on: ubuntu-latest
    needs: test
    strategy:
      fail-fast: true
      matrix:
        include:
          - package: opus_codec_dart
            directory: opus_dart
            tool: dart
          - package: opus_codec_platform_interface
            directory: opus_flutter_platform_interface
            tool: flutter
    steps:
      - uses: actions/checkout@v6
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: stable
      - name: Rewrite path deps to version constraints
        run: dart run scripts/prepare_publish.dart ${{ matrix.directory }}
      - name: Publish (dry run)
        if: ${{ inputs.dry-run }}
        working-directory: ${{ matrix.directory }}
        run: ${{ matrix.tool }} pub publish --dry-run
      - name: Publish
        if: ${{ !inputs.dry-run }}
        working-directory: ${{ matrix.directory }}
        run: ${{ matrix.tool }} pub publish --force

  wait-tier-1:
    name: Wait for pub.dev indexing (tier 1)
    runs-on: ubuntu-latest
    needs: publish-tier-1
    steps:
      - name: Wait 120s for pub.dev to index tier-1 packages
        if: ${{ !inputs.dry-run }}
        run: sleep 120

  publish-tier-2:
    name: 'Publish: ${{ matrix.package }}'
    runs-on: ubuntu-latest
    needs: [publish-tier-1, wait-tier-1]
    strategy:
      fail-fast: true
      matrix:
        include:
          - package: opus_codec_android
            directory: opus_flutter_android
          - package: opus_codec_ios
            directory: opus_flutter_ios
          - package: opus_codec_linux
            directory: opus_flutter_linux
          - package: opus_codec_macos
            directory: opus_flutter_macos
          - package: opus_codec_windows
            directory: opus_flutter_windows
          - package: opus_codec_web
            directory: opus_flutter_web
    steps:
      - uses: actions/checkout@v6
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: stable
      - name: Rewrite path deps to version constraints
        run: dart run scripts/prepare_publish.dart ${{ matrix.directory }}
      - name: Publish (dry run)
        if: ${{ inputs.dry-run }}
        working-directory: ${{ matrix.directory }}
        run: flutter pub publish --dry-run
      - name: Publish
        if: ${{ !inputs.dry-run }}
        working-directory: ${{ matrix.directory }}
        run: flutter pub publish --force

  wait-tier-2:
    name: Wait for pub.dev indexing (tier 2)
    runs-on: ubuntu-latest
    needs: publish-tier-2
    steps:
      - name: Wait 120s for pub.dev to index tier-2 packages
        if: ${{ !inputs.dry-run }}
        run: sleep 120

  publish-tier-3:
    name: 'Publish: opus_codec'
    runs-on: ubuntu-latest
    needs: [publish-tier-2, wait-tier-2]
    steps:
      - uses: actions/checkout@v6
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: stable
      - name: Rewrite path deps to version constraints
        run: dart run scripts/prepare_publish.dart opus_flutter
      - name: Publish (dry run)
        if: ${{ inputs.dry-run }}
        working-directory: opus_flutter
        run: flutter pub publish --dry-run
      - name: Publish
        if: ${{ !inputs.dry-run }}
        working-directory: opus_flutter
        run: flutter pub publish --force
