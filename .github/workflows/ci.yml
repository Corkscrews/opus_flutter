name: CI

on:
  push:
    branches: [master, development]
  pull_request:
    branches: [master, development]

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Run static analysis
        run: ./scripts/analyze.sh
      - name: Check formatting
        run: ./scripts/format.sh

  test:
    name: Unit tests
    runs-on: ubuntu-latest
    needs: analyze
    steps:
      - uses: actions/checkout@v6
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Run unit tests
        run: ./scripts/unit_tests.sh

  build-example-android:
    name: Build example (Android)
    runs-on: ubuntu-latest
    needs: [analyze, test]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 17
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Build APK
        working-directory: opus_flutter/example
        run: flutter pub get && flutter build apk --debug

  build-example-apple:
    name: Build example (iOS + macOS)
    runs-on: macos-latest
    needs: [analyze, test]
    steps:
      - uses: actions/checkout@v6
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Install dependencies
        working-directory: opus_flutter/example
        run: flutter pub get
      - name: Build iOS (no codesign)
        working-directory: opus_flutter/example
        run: flutter build ios --debug --no-codesign
      - name: Build macOS
        working-directory: opus_flutter/example
        run: flutter build macos --debug

  build-example-linux:
    name: Build example (Linux)
    runs-on: ubuntu-latest
    needs: [analyze, test]
    steps:
      - uses: actions/checkout@v6
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build libgtk-3-dev
      - name: Build Linux
        working-directory: opus_flutter/example
        run: flutter pub get && flutter build linux --debug

  build-example-windows:
    name: Build example (Windows)
    runs-on: windows-latest
    needs: [analyze, test]
    steps:
      - uses: actions/checkout@v6
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Build Windows
        working-directory: opus_flutter/example
        run: flutter pub get && flutter build windows --debug

  build-example-web:
    name: Build example (Web)
    runs-on: ubuntu-latest
    needs: [analyze, test]
    steps:
      - uses: actions/checkout@v6
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Build web
        working-directory: opus_flutter/example
        run: flutter pub get && flutter build web
