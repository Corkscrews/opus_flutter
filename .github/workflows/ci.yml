name: CI

on:
  push:
    branches: [master, development]
  pull_request:
    branches: [master, development]

jobs:
  analyze-and-test:
    name: Analyze & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: stable
      - name: Check formatting
        run: ./scripts/format.sh
      - name: Run static analysis
        run: ./scripts/analyze.sh
      - name: Run unit tests
        run: ./scripts/unit_tests.sh
      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: opus_dart/coverage/

  build-example-android:
    name: Build example (Android)
    runs-on: ubuntu-latest
    needs: analyze-and-test
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 17
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: stable
      - name: Build APK
        working-directory: opus_flutter/example
        run: flutter pub get && flutter build apk --debug

  build-example-apple:
    name: Build example (iOS + macOS)
    runs-on: macos-latest
    needs: analyze-and-test
    steps:
      - uses: actions/checkout@v6
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: stable
      - name: Install dependencies
        working-directory: opus_flutter/example
        run: flutter pub get
      - name: Build iOS (no codesign)
        working-directory: opus_flutter/example
        run: flutter build ios --debug --no-codesign
      - name: Build macOS
        working-directory: opus_flutter/example
        run: flutter build macos --debug

  build-example-linux:
    name: Build example (Linux)
    runs-on: ubuntu-latest
    needs: analyze-and-test
    steps:
      - uses: actions/checkout@v6
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: stable
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build libgtk-3-dev
      - name: Build Linux
        working-directory: opus_flutter/example
        run: flutter pub get && flutter build linux --debug

  build-example-windows:
    name: Build example (Windows)
    runs-on: windows-latest
    needs: analyze-and-test
    steps:
      - uses: actions/checkout@v6
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: stable
      - name: Build Windows
        working-directory: opus_flutter/example
        run: flutter pub get && flutter build windows --debug

  deploy-web:
    name: Build & Deploy Web
    runs-on: ubuntu-latest
    needs: analyze-and-test
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v6
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: stable
      - name: Build web (release)
        working-directory: opus_flutter/example
        run: flutter pub get && flutter build web --release --base-href /opus_flutter/
      - name: Upload Pages artifact
        if: github.event_name == 'push'
        uses: actions/upload-pages-artifact@v3
        with:
          path: opus_flutter/example/build/web
      - name: Deploy to GitHub Pages
        if: github.event_name == 'push'
        id: deployment
        uses: actions/deploy-pages@v4
